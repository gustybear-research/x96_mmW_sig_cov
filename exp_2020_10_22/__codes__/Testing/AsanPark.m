
%viewer = siteviewer("Buildings", "Asan.osm");

lat = [13.473947 13.473172 13.475753 13.474981 13.474682 13.473682 13.473717 13.471296];
lon = [144.708133 144.708293 144.707848 144.708669 144.708796 144.711611 144.712720 144.706369];
freq = 4.7e9;
Power = 2500000;
resultPower = [];
for freq = 4.7e9:0.5e9:9.7e9
tx = txsite('Name','Center of Asan',...
      	'Latitude',13.473615,...
        'Longitude',144.709086,...
        'AntennaHeight',30, ...
        'TransmitterFrequency', freq, ...
        'TransmitterPower', Power);
rx = rxsite('Name','Trap Locations', ...
   	'Latitude',lat,...
    'Longitude',lon,...
    'AntennaHeight',3);
[dBmOut] = raytraceout(tx,rx, 'NumReflections',[0])
min_dBm = min(dBmOut); 
min_dBm = min_dBm - 3;  % cut in half
txPower = 10.^((min_dBm-30)/10); % Convert dBm to W

txback = txsite('Name','Furthest Receiver',...
      	'Latitude',13.473717,...
        'Longitude',144.71272,...
        'AntennaHeight',3, ...
        'TransmitterFrequency', 2*freq, ...
        'TransmitterPower', txPower);
rxback = rxsite('Name','Receiving reflected signal', ...
   	'Latitude',13.473615,'Longitude',144.709086,...
    'AntennaHeight',30);
lastdBmOut = raytraceout(txback, rxback, "NumReflections",[0]);
lastdBmOut = lastdBmOut + 28.5


while(lastdBmOut < -101 || lastdBmOut > -99)
if(lastdBmOut < -101)
    Power = abs(lastdBmOut/100) * Power;
else
    Power = abs(lastdBmOut/100) * Power;
end
tx = txsite('Name','Center of Asan',...
      	'Latitude',13.473615,...
        'Longitude',144.709086,...
        'AntennaHeight',30, ...
        'TransmitterFrequency', freq, ...
        'TransmitterPower', Power);
rx = rxsite('Name','Trap Locations', ...
   	'Latitude',lat,...
    'Longitude',lon,...
    'AntennaHeight',3);
[dBmOut] = raytraceout(tx,rx, 'NumReflections',[0])
min_dBm = min(dBmOut); 
min_dBm = min_dBm - 3;  % cut in half
txPower = 10.^((min_dBm-30)/10); % Convert dBm to W

txback = txsite('Name','Furthest Receiver',...
      	'Latitude',13.473717,...
        'Longitude',144.71272,...
        'AntennaHeight',3, ...
        'TransmitterFrequency', 2*freq, ...
        'TransmitterPower', txPower);
rxback = rxsite('Name','Receiving reflected signal', ...
   	'Latitude',13.473615,'Longitude',144.709086,...
    'AntennaHeight',30);
[lastdBmOut] = raytraceout(txback, rxback, "NumReflections",[0]);
lastdBmOut = lastdBmOut + 28.5
end
resultPower = [resultPower Power]
end
